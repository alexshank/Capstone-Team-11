
/******************************************************************************
Alex Shank - 11/14/20

Tests the MSP430 FFT results of 512 test samples acquired from the on-board
ADC configured with the analog microphone
*******************************************************************************/
#include <driverlib/MSP430FR5xx_6xx/driverlib.h>
#include <math.h>
#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>
#include "DSPLib.h"

// input signal parameters
#define SAMPLES             512

// input signal and FFT result
DSPLIB_DATA(input, MSP_ALIGN_FFT_Q15(SAMPLES))
// ADC samples from microphone listening to 500 Hz test signal
int16_t input[SAMPLES] = { 2143,2146,2144,2128,2055,1995,1937,1927,1914,1900,1939,
    1959,2062,2100,2151,2159,2190,2172,2131,2067,2007,
    1954,1911,1867,1896,1913,1975,2007,2084,2113,2159,
    2143,2136,2108,2039,1967,1928,1907,1887,1886,1948,
    1984,2055,2090,2147,2151,2159,2123,2081,2003,1949,
    1948,1896,1887,1927,1948,2031,2051,2124,2160,2175,
    2165,2138,2088,2037,1967,1924,1912,1939,1895,1960,
    2007,2079,2115,2172,2192,2175,2127,2091,2039,1991,
    1943,1913,1899,1951,1968,2055,2096,2151,2164,2175,
    2143,2126,2094,2033,1968,1922,1889,1915,1919,1992,
    2033,2111,2139,2172,2179,2175,2111,2060,2028,1967,
    1931,1912,1921,1949,1967,2072,2099,2167,2182,2185,
    2161,2129,2059,2009,1959,1931,1909,1952,1975,2059,
    2068,2161,2175,2219,2215,2176,2135,2071,2018,1968,
    1936,1929,1927,1985,2015,2092,2114,2160,2167,2167,
    2135,2089,2015,1967,1930,1905,1899,1962,1982,2035,
    2071,2158,2174,2211,2191,2166,2108,2032,1983,1957,
    1924,1943,1943,1996,2041,2119,2143,2176,2168,2159,
    2131,2064,2024,1963,1919,1888,1895,1943,1967,2044,
    2083,2159,2163,2169,2135,2111,2041,1985,1959,1919,
    1884,1904,1919,1999,2020,2111,2141,2180,2184,2160,
    2111,2044,1984,1947,1902,1884,1896,1943,1975,2041,
    2087,2135,2131,2136,2112,2051,1995,1952,1905,1891,
    1871,1904,1917,1988,2024,2111,2123,2170,2177,2128,
    2091,2028,1988,1951,1915,1905,1923,1983,2019,2108,
    2153,2199,2175,2176,2135,2087,2031,1980,1952,1927,
    1898,1952,1971,2047,2079,2136,2167,2191,2159,2124,
    2088,2007,1943,1921,1895,1915,1910,1984,2016,2094,
    2116,2179,2159,2157,2103,2048,2001,1943,1910,1899,
    1899,1950,1992,2079,2107,2176,2184,2192,2167,2116,
    2065,2013,1951,1928,1920,1941,1951,2017,2065,2127,
    2159,2188,2184,2159,2095,2048,2000,1949,1913,1923,
    1911,1978,2024,2107,2127,2180,2188,2187,2135,2092,
    2041,1983,1923,1900,1887,1943,1958,2032,2069,2135,
    2142,2163,2143,2123,2070,2017,1953,1914,1884,1909,
    1923,1986,2036,2109,2123,2170,2185,2179,2131,2087,
    2028,1991,1935,1932,1928,1975,2011,2084,2121,2175,
    2183,2214,2190,2129,2079,1996,1960,1919,1901,1916,
    1948,2027,2043,2112,2151,2187,2159,2156,2099,2047,
    1983,1945,1920,1919,1919,1984,2007,2094,2116,2177,
    2183,2207,2174,2129,2079,2027,1983,1961,1939,1954,
    2008,2047,2095,2170,2188,2224,2191,2162,2100,2051,
    2007,1958,1920,1927,1915,1988,2024,2099,2149,2176,
    2184,2191,2147,2080,2032,1967,1926,1937,1927,1965,
    1983,2056,2099,2162,2196,2193,2175,2143,2085,2035,
    1959,1946,1928,1943,1951,2010,2040,2097,2127,2172,
    2156,2135,2111,2046,1988,1936,1903,1898,1900,1939,
    1967,2056,2087,2143,2151,2166,2136,2095,2031,1980,
    1927,1927,1887,1920,1939,1999,2058,2123,2175,2187,
    2182,2145,2107,2053,2013,1953,1927,1902,1924,1983,
    2011,2078,2124,2176,2165,2170,2124,2081,2015,1967,
    1926
};

// benchmark cycle counts
volatile uint32_t cycleCount;

void main(void)
{
    WDT_A_hold(WDT_A_BASE);                     // disable watchdog timer
    PMM_unlockLPM5();                           // unlock the GPIO power-on default mode
    
    msp_status status;

    // initialize the fft parameter structure
    msp_fft_q15_params fftParams;
    fftParams.length = SAMPLES;
    fftParams.bitReverse = true;
    fftParams.twiddleTable = NULL;  // can use NULL pointer when LEA being used

    // perform real FFT with fixed scaling
    msp_benchmarkStart(MSP_BENCHMARK_BASE, 16);
    status = MAP_msp_fft_fixed_q15(&fftParams, input);
    cycleCount = msp_benchmarkStop(MSP_BENCHMARK_BASE);
    msp_checkStatus(status);

    __no_operation();
}
